# 实例

1. 更新 Config.cs 中的配置

```
public static IEnumerable<ApiResource> GetApiResource()
{
    return new List<ApiResource>
    {
        new ApiResource("contactResource", "Contact Management Service")  // 使用您自定义的名称
        {
            Scopes = {
                "contact_api",          // 基础访问权限（保持向后兼容）
                "contact.read",         // 读取联系人权限
                "contact.write",        // 写入联系人权限
                "contact.manage",       // 管理联系人权限
                "contact.admin"         // 管理员权限
            }
        },
        new ApiResource("gateway_api", "Gateway API Service")
        {
            Scopes = { "gateway_api" }
        },
        new ApiResource("user_api", "User API Service")
        {
            Scopes = { "user_api" }
        }
    };
}
public static IEnumerable<ApiScope> GetApiScopes()
{
    return new List<ApiScope>
    {
        // Contact相关的scopes
        new ApiScope("contact_api", "Basic contact API access"),
        new ApiScope("contact.read", "Read contacts"),
        new ApiScope("contact.write", "Write contacts"),
        new ApiScope("contact.manage", "Manage contacts"),
        new ApiScope("contact.admin", "Admin contacts"),

        // 其他scopes
        new ApiScope("gateway_api", "Gateway API access"),
        new ApiScope("user_api", "User API access")
    };
}
public static IEnumerable<Client> GetClients()
{
    return new List<Client>
    {
        new Client
        {
            ClientId = "android",
            ClientSecrets = { new Secret("secret".Sha256()) },
            AllowOfflineAccess = true,
            RequireClientSecret = false,
            AllowedGrantTypes = new List<string> { "sms_code" },
            AllowedScopes =
            {
                "gateway_api",
                "user_api",
                "contact_api",          // 基础权限
                "contact.read",         // 读取权限
                "contact.write",        // 写入权限
                "contact.manage",       // 管理权限
                "contact.admin",        // 管理员权限
                IdentityServerConstants.StandardScopes.OpenId,
                IdentityServerConstants.StandardScopes.Profile,
                IdentityServerConstants.StandardScopes.OfflineAccess,
            },
        }
    };
}
```

2. 在 API 项目中更新配置

```
services.AddAuthentication("Bearer")
    .AddIdentityServerAuthentication(options =>
    {
        options.Authority = "https://your-identity-server.com";
        options.ApiName = "contactResource";  // 这里使用您自定义的名称
        options.RequireHttpsMetadata = false; // 根据环境调整
    });
```

3. 更新 ContactController 的权限控制

```

[ApiController]
[Route("api/contacts")]
[Authorize] // 要求认证，并且令牌的aud必须包含"contactResource"
public class ContactController : BaseController
{
    // 构造函数保持不变...

    [HttpGet]
    [Route("")]
    [Authorize(Policy = "Contact.Read")] // 需要contact.read scope
    public async Task<IActionResult> Get(CancellationToken cancellationToken)
    {
        return Ok(await _contactRepository.GetContactsAsync(UserIdentity.UserId, cancellationToken));
    }

    [HttpPut]
    [Route("tags")]
    [Authorize(Policy = "Contact.Write")] // 需要contact.write scope
    public async Task<IActionResult> TagContact([FromBody] TagContactInputViewModel viewModel, CancellationToken cancellationToken)
    {
        // 实现...
    }

    [HttpGet]
    [Route("apply-requests")]
    [Authorize(Policy = "Contact.Manage")] // 需要contact.manage scope
    public async Task<IActionResult> GetApplyRequests(CancellationToken cancellationToken = default)
    {
        // 实现...
    }

    [HttpPost]
    [Route("apply-requests/{userId}")]
    [Authorize(Policy = "Contact.Write")] // 需要contact.write scope
    public async Task<IActionResult> AddApplyRequest(int userId, CancellationToken cancellationToken = default)
    {
        // 实现...
    }

    [HttpPut]
    [Route("apply-requests/{applierId}")]
    [Authorize(Policy = "Contact.Manage")] // 需要contact.manage scope
    public async Task<IActionResult> ApprovalRequestAsync(int applierId, CancellationToken cancellationToken = default)
    {
        // 实现...
    }
}
```

4. 授权策略配置

```

services.AddAuthorization(options =>
{
    options.AddPolicy("Contact.Read", policy =>
        policy.RequireAssertion(context =>
            context.User.HasClaim(c =>
                c.Type == "scope" &&
                (c.Value == "contact_api" || c.Value == "contact.read" ||
                 c.Value == "contact.manage" || c.Value == "contact.admin")
            )));

    options.AddPolicy("Contact.Write", policy =>
        policy.RequireAssertion(context =>
            context.User.HasClaim(c =>
                c.Type == "scope" &&
                (c.Value == "contact_api" || c.Value == "contact.write" ||
                 c.Value == "contact.manage" || c.Value == "contact.admin")
            )));

    options.AddPolicy("Contact.Manage", policy =>
        policy.RequireAssertion(context =>
            context.User.HasClaim(c =>
                c.Type == "scope" &&
                (c.Value == "contact.manage" || c.Value == "contact.admin")
            )));

    options.AddPolicy("Contact.Admin", policy =>
        policy.RequireScope("contact.admin"));
});
```

# 需要理解 scope 方式认证的 原理

方法头上写的是策略名字[Authorize(Policy = "Contact.Write")]

然后后 AddAuthorization 这里定义的是对应策略要求的 scope

问题是，用户想申请什么 scope 就申请什么 scope 了吗，之后查一下
