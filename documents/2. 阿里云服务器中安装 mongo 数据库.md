# 阿里云服务器中安装 mongo 数据库

8.140.59.193

## 问题 1

无法下载 mongo 镜像了

## 方案：

重新执行(User API 工程的文档 18. 线上测试环境准备.md 里已有)

```
sudo tee /etc/docker/daemon.json <<-'EOF'
{
"registry-mirrors": ["https://iwkank6b.mirror.aliyuncs.com"]
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker
```

执行以上操作会带来已经运行的容器全部都停止了
root@iZ2zei3r7rzlqshgwyxji1Z:~# docker start UserApiMysql001
root@iZ2zei3r7rzlqshgwyxji1Z:~# docker start userapi001

```
root@iZ2zei3r7rzlqshgwyxji1Z:~# docker ps -a
CONTAINER ID   IMAGE                                                             COMMAND                  CREATED         STATUS                      PORTS     NAMES
1e22320a4009   mongo:latest                                                      "docker-entrypoint.s…"   4 minutes ago   Exited (1) 4 minutes ago              mongodb
11dbf2c3eda9   registry.cn-hangzhou.aliyuncs.com/microsoftservice/userapi:test   "dotnet User.API.dll"    4 weeks ago     Exited (0) 27 minutes ago             userapi001
a8079e62199f   mysql:latest                                                      "docker-entrypoint.s…"   4 weeks ago     Exited (0) 27 minutes ago             UserApiMysql001

```

## 新建 mongo 容器

1. 创建数据存储目录及配置文件
   1.1 创建 MongoDB 数据目录

```
# 创建主目录
sudo mkdir -p /mnt/mongo_data/{db,configdb,conf}

# 创建配置文件（可选）
sudo touch /mnt/mongo_data/conf/mongod.conf
```

1.2 设置目录权限

```
# 将目录所有权赋予MongoDB的默认用户（UID=999，GID=999）
sudo chown -R 999:999 /mnt/mongo_data

# 或赋予当前用户权限（二选一）
# sudo chown -R $(whoami):$(whoami) /mnt/mongo_data

# 设置目录权限
sudo chmod -R 755 /mnt/mongo_data

```

2. 准备 MongoDB 配置文件（可选）
   2.1 生成默认配置文件

```
# 临时启动一个MongoDB容器获取默认配置
docker run --rm mongo:latest mongod --help > /mnt/mongo_data/conf/mongod.conf.template
```

2.2 编辑自定义配置（示例）

```
sudo vim /mnt/mongo_data/conf/mongod.conf

storage:
  dbPath: /data/db
  journal:
    enabled: true
systemLog:
  destination: file
  logAppend: true
  path: /var/log/mongodb/mongod.log
net:
  port: 27017
  bindIp: 0.0.0.0
security:
  authorization: enabled
```

3. 启动 MongoDB 容器

3.1 完整挂载命令（含配置文件）(我用的这个)

```
docker run -d \
  -p 27017:27017 \
  --name mongodb \
  -v /mnt/mongo_data/db:/data/db \
  -v /mnt/mongo_data/configdb:/data/configdb \
  -v /mnt/mongo_data/conf/mongod.conf:/etc/mongod.conf \
  -v /mnt/mongo_data/logs:/var/log/mongodb \
  -e MONGO_INITDB_ROOT_USERNAME=root \
  -e MONGO_INITDB_ROOT_PASSWORD=acsdev312 \
  mongo:latest --config /etc/mongod.conf
```

3.2 简化命令（无配置文件）

```
docker run -d \
  -p 27017:27017 \
  --name mongodb \
  -v /mnt/mongo_data/db:/data/db \
  -v /mnt/mongo_data/configdb:/data/configdb \
  -e MONGO_INITDB_ROOT_USERNAME=root \
  -e MONGO_INITDB_ROOT_PASSWORD=acsdev312 \
  mongo:latest
```

# 问题 1

容器没启动成功，立马退出了

```
1e22320a4009   mongo:latest                                                      "docker-entrypoint.s…"   7 minutes ago   Exited (1) 20 seconds ago
```

docker logs mongodb

```
{"t":{"$date":"2025-08-16T23:41:50.067Z"},"s":"F",  "c":"CONTROL",  "id":20574,   "ctx":"-","msg":"Error during global initialization","attr":{"error":{"code":38,"codeName":"FileNotOpen","errmsg":"Can't initialize rotatable log file :: caused by :: Failed to open /var/log/mongodb/mongod.log"}}}
{"t":{"$date":"2025-08-16T23:48:45.403Z"},"s":"F",  "c":"CONTROL",  "id":20574,   "ctx":"-","msg":"Error during global initialization","attr":{"error":{"code":38,"codeName":"FileNotOpen","errmsg":"Can't initialize rotatable log file :: caused by :: Failed to open /var/log/mongodb/mongod.log"}}}

```

# 方案：

```
sudo mkdir -p /mnt/mongo_data/logs
sudo chown -R 999:999 /mnt/mongo_data/logs  # MongoDB容器内用户UID=999

docker run -d \
  --name mongodb \
  -p 27017:27017 \
  -v /mnt/mongo_data/db:/data/db \
  -v /mnt/mongo_data/configdb:/data/configdb \
  -v /mnt/mongo_data/logs:/var/log/mongodb \
  -e MONGO_INITDB_ROOT_USERNAME=root \
  -e MONGO_INITDB_ROOT_PASSWORD=acsdev312 \
  mongo:latest
```

# 进入容器进行测试

```
root@iZ2zei3r7rzlqshgwyxji1Z:~# docker exec -it mongodb mongosh -u root -p acsdev312

```

# 研究本地 windows 中用 mongoDb Compass 链接 阿里云上的 mongoDb

阿里云上安全组打开后

```
PS D:\Code\1.microservice\1.netcore_microservice_docker> Test-NetConnection 8.140.59.193 -Port 27017                                                                                                                                                                                                                                                                    ComputerName     : 8.140.59.193                                                                                         RemoteAddress    : 8.140.59.193                                                                                         RemotePort       : 27017
InterfaceAlias   : WLAN
SourceAddress    : 192.168.1.8
TcpTestSucceeded : True
```

sudo touch /mnt/mongo_data/logs/mongod.log
sudo chown 999:999 /mnt/mongo_data/logs/mongod.log

```
docker run -d \
  --name mongodb \
  -p 27017:27017 \
  -v /mnt/mongo_data/db:/data/db \
  -v /mnt/mongo_data/configdb:/data/configdb \
  -v /mnt/mongo_data/logs:/var/log/mongodb \
  -v /mnt/mongo_data/conf/mongod.conf:/etc/mongod.conf \
  -e MONGO_INITDB_ROOT_USERNAME=root \
  -e MONGO_INITDB_ROOT_PASSWORD=acsdev312 \
  mongo:latest --config /etc/mongod.conf
```

docker exec -it mongodb mongosh -u root -p acsdev312 --eval "db.adminCommand({ping:1})"

# compass 中连接串：

mongodb://root:acsdev312@8.140.59.193:27017/?authSource=admin
