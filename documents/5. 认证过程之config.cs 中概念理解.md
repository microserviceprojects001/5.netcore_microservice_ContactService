# éœ€è¦ç†è§£çš„é—®é¢˜

1. Identity server ä¸­ Config.cs ä¸­é…ç½®çš„ç†è§£

2. è®¤è¯è¿‡ç¨‹çš„ç†è§£

- é¦–å…ˆéœ€è¦å¸¦ç€ clientï¼Œ secretï¼Œ scope ç­‰ä¿¡æ¯å»ç”³è¯· token
  æ‹¿åˆ° token åï¼ŒAPI éœ€è¦æºå¸¦ token å»å‘é€è¯·æ±‚ï¼Œæ­¤æ—¶éƒ½æ˜¯æ€ä¹ˆå»éªŒè¯çš„ï¼Œ
  åŒ…æ‹¬ Gateway çš„éªŒè¯ï¼Œå’Œ API Server çš„éªŒè¯ï¼Œéƒ½æ˜¯å¦‚ä½•éªŒè¯çš„.

401 ç½‘å…³æ²¡è®¤è¯è¿‡å»
403 æ˜¯ API æ²¡è®¤è¯è¿‡å»

# å¼€å§‹ç†è§£è®¤è¯è¿‡ç¨‹

ç°åœ¨æˆ‘çš„å¾®æœåŠ¡å·²ç»å¼€å‘äº†ä¸€äº›å‡ºæ¥ï¼ŒåŒ…æ‹¬ User.API, Contact.API, User.Identity, API Gate way,æˆ‘ç°åœ¨æƒ³æ‹é¡ºä¸€ä¸‹è®¤è¯è¿‡ç¨‹ï¼Œconfig.cs æˆ‘æƒ³å¯¹è¿™é‡Œå®šä¹‰çš„æ¦‚å¿µæœ‰ä¸€ä¸ªç†è§£ï¼Œå…ˆè¯´ GetClients()æ–¹æ³•è¿™é‡Œå®šä¹‰çš„å°±æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„ client å—ï¼Œæ˜¯ä¸€ä¸ªå¤§çš„æ¦‚å¿µï¼Œæ¯”æ–¹è¯´ç®€ä¹¦ç”¨å¾®ä¿¡åŒºè®¤è¯ç™»å½•ï¼Œé‚£ç®€ä¹¦å°±æ˜¯ä¸€ä¸ª clientï¼Œç„¶åæœ‰ä»–è‡ªå·±çš„ å¥½å¤šä¸ª AllowedScopes

1. Clientï¼ˆå®¢æˆ·ç«¯ï¼‰
   æ‚¨çš„ç†è§£å®Œå…¨æ­£ç¡®ï¼šClient å°±æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åº
   ä¾‹å­ï¼šç®€ä¹¦ç”¨å¾®ä¿¡ç™»å½• â†’ ç®€ä¹¦å°±æ˜¯ Client
   åœ¨æ‚¨çš„ç³»ç»Ÿä¸­ï¼šandroid å°±æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä»£è¡¨ç§»åŠ¨ç«¯åº”ç”¨

# Client å®šä¹‰äº†å“ªäº› scope ï¼Œå¿…é¡»è¦åœ¨ GetApiScopes æœ‰ä¸ä¹‹å¯¹åº”çš„å®šä¹‰å“ˆ

æ‚¨è¯´å¾—å®Œå…¨æ­£ç¡®ï¼è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µã€‚
å…³é”®è§„åˆ™
ä¸€ä¸€å¯¹åº”ï¼šClient çš„ AllowedScopes ä¸­çš„æ¯ä¸ªè‡ªå®šä¹‰ scope éƒ½å¿…é¡»åœ¨
GetApiScopes()ä¸­æœ‰å¯¹åº”çš„å®šä¹‰

æ ‡å‡† scope ä¾‹å¤–ï¼šopenid, profile, offline_access ç­‰æ˜¯ IdentityServer çš„æ ‡å‡† scopeï¼Œä¸éœ€è¦åœ¨
GetApiScopes()
ä¸­å®šä¹‰

éªŒè¯æœºåˆ¶ï¼šå¦‚æœ Client è¯·æ±‚äº†æœªåœ¨
GetApiScopes()
ä¸­å®šä¹‰çš„ scopeï¼ŒIdentityServer ä¼šæ‹’ç»è¯¥è¯·æ±‚

# new ApiScope("gateway_api", "My API Scope"), è¿™ä¸ªå®šä¹‰æœ‰ä»€ä¹ˆå…·ä½“å«ä¹‰å—ï¼Œç¬¬äºŒä¸ªå‚æ•° æ˜¯æè¿°å—

æ˜¯çš„ï¼Œæ‚¨ç†è§£å¾—å®Œå…¨æ­£ç¡®ï¼

1. ç¬¬ä¸€ä¸ªå‚æ•° ("gateway_api")ï¼šScope çš„å”¯ä¸€æ ‡è¯†ç¬¦

è¿™æ˜¯å¿…é¡»çš„ï¼Œç”¨äºåœ¨ç³»ç»Ÿä¸­å”¯ä¸€æ ‡è¯†è¿™ä¸ª scope
Client è¯·æ±‚å’Œ API éªŒè¯æ—¶éƒ½ä½¿ç”¨è¿™ä¸ªæ ‡è¯†

2. ç¬¬äºŒä¸ªå‚æ•° ("My API Scope")ï¼šæ˜¾ç¤ºåç§°/æè¿°

è¿™æ˜¯å¯é€‰çš„ï¼Œç”¨äºåœ¨åŒæ„å±å¹•ç­‰ç”¨æˆ·ç•Œé¢ä¸Šæ˜¾ç¤º
ç»™ç”¨æˆ·çœ‹çš„å‹å¥½åç§°ï¼Œè¯´æ˜è¿™ä¸ª scope çš„ç”¨é€”

# ä½ çš„æ„æ€æ˜¯è¯´ç¬¬äºŒä¸ªå‚æ•°æ˜¯ consent æˆæƒé¡µé¢ä¸Š ä¼šæ˜¾ç¤ºçš„å—

æ˜¯çš„ï¼Œæ‚¨ç†è§£å¾—å®Œå…¨æ­£ç¡®

```
new ApiScope("gateway_api", "My API Scope")
```

ç¬¬ä¸€ä¸ªå‚æ•° ("gateway_api")ï¼šç³»ç»Ÿå†…éƒ¨ä½¿ç”¨çš„æŠ€æœ¯æ ‡è¯†
ç¬¬äºŒä¸ªå‚æ•° ("My API Scope")ï¼šåœ¨åŒæ„å±å¹•(consent screen)ä¸Šæ˜¾ç¤ºç»™ç”¨æˆ·çš„å‹å¥½æè¿°

## æ•ˆæœ

åº”ç”¨ç¨‹åº "Android App" è¯·æ±‚è®¿é—®ï¼š

â˜‘ï¸ My API Scope - è®¿é—®ç½‘å…³ API æœåŠ¡  
â˜‘ï¸ my contact scope - ç®¡ç†è”ç³»äººä¿¡æ¯
â˜‘ï¸ user_api scope - è®¿é—®ç”¨æˆ·æ•°æ®

[åŒæ„] [æ‹’ç»]

# é‚£å…¶ä¸­ GetApiResource æ˜¯æ˜¯ä½ ç”¨é€”å‘¢ï¼Œè¿™ä¸ªä¼¼ä¹æ˜¯æ—§ç‰ˆæœ¬ dotnet é‡Œæ²¡æœ‰è¿™ä¸ªæ¦‚å¿µ

```
public static IEnumerable<ApiResource> GetApiResource()
{
    return new List<ApiResource>
    {
        new ApiResource("gateway_api", "user api service")
        {
            Scopes = { "gateway_api" }  // å…³è”åˆ° ApiScope
        },
        new ApiResource("contact_api", "contact service")
        {
            Scopes = { "contact_api" }
        },
        new ApiResource("user_api", "user api") {
            Scopes = { "user_api" }
        }
    };
}
```

# ApiResource æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ¦‚å¿µï¼Œè€Œ ApiScope æ˜¯å°å¾—æ¦‚å¿µå—

æ‚¨çš„ç†è§£å®Œå…¨æ­£ç¡®ï¼ğŸ‘

å¾ˆå¥½çš„æ¯”å–»ç†è§£ï¼š
ğŸ¢ ApiResource - å¤§æ¥¼

- ä»£è¡¨ä¸€ä¸ªå®Œæ•´çš„ API æœåŠ¡ï¼ˆå¦‚ä¸€æ ‹åŠå…¬å¤§æ¥¼ï¼‰

- å®šä¹‰äº†"è¿™æ˜¯ä»€ä¹ˆæœåŠ¡"ï¼ˆå¦‚è”ç³»äººç®¡ç†æœåŠ¡ï¼‰

- åœ¨ä»¤ç‰Œä¸­ä½œä¸º audï¼ˆè§‚ä¼—ï¼‰å‡ºç°ï¼Œè¡¨ç¤º"è¿™ä¸ªä»¤ç‰Œå¯ä»¥è¿›å…¥è¿™æ ‹å¤§æ¥¼"

- ä¾‹å­ï¼šcontactResourceï¼ˆè”ç³»äººç®¡ç†å¤§æ¥¼ï¼‰

ğŸšª ApiScope - æˆ¿é—´æƒé™

- ä»£è¡¨å…·ä½“çš„æ“ä½œæƒé™ï¼ˆå¦‚å¤§æ¥¼é‡Œçš„å„ä¸ªæˆ¿é—´ï¼‰

- å®šä¹‰äº†"å¯ä»¥åœ¨è¿™ä¸ªæœåŠ¡é‡Œåšä»€ä¹ˆ"ï¼ˆå¦‚è¯»å–è”ç³»äººã€ç®¡ç†è¯·æ±‚ï¼‰

- åœ¨ä»¤ç‰Œä¸­ä½œä¸º scope å£°æ˜å‡ºç°ï¼Œè¡¨ç¤º"å¯ä»¥è¿›å…¥å“ªäº›æˆ¿é—´"

- ä¾‹å­ï¼šcontact.readï¼ˆå¯ä»¥è¿›å…¥é˜…è¯»å®¤ï¼‰ã€contact.manageï¼ˆå¯ä»¥è¿›å…¥ç®¡ç†å®¤ï¼‰

# å¥½ï¼Œæ¯”æ–¹è¯´æˆ‘ç”¨ postman å‘é€è¯·æ±‚ å»å¾—åˆ°ä»¤ç‰Œäº†ï¼Œè¯·æ±‚ä¸­ä¼šæœ‰ Clientï¼Œ secretï¼Œ Scope å‚æ•°ï¼Œæˆ‘æƒ³é—® scope å‚æ•°é‡Œå¡«çš„ contact_api ï¼Œå’Œæˆ‘ä»¬åˆšåˆšè®¨è®ºå¾—æ¦‚å¿µæ˜¯å’Œè°å¯¹åº”çš„å‘¢

scope å‚æ•°é‡Œå¡«çš„ contact_api å¯¹åº”çš„æ˜¯æˆ‘ä»¬è®¨è®ºçš„ ApiScopeï¼ˆå°æ¦‚å¿µ/æˆ¿é—´æƒé™ï¼‰ã€‚

# options.ApiName = "contactResource"; // â† è¿™é‡Œä½¿ç”¨å¤§æ¥¼åç§°ï¼å°±æ˜¯è¯´å¯åŠ¨é…ç½®ä¸­ éœ€è¦æ”¹æˆè¿™æ ·ï¼Œé‚£å½“æˆ‘ç”¨ postman å»è¯·æ±‚ä»¤ç‰Œçš„æ—¶å€™ï¼Œæœ‰ä»€ä¹ˆç‰¹å®šå‚æ•°éœ€è¦è®¾å®šå—

å½“æ‚¨åœ¨ Postman ä¸­è¯·æ±‚ä»¤ç‰Œæ—¶ï¼Œä¸éœ€è¦ç›´æ¥æŒ‡å®šå¤§æ¥¼åç§°ï¼ˆApiResourceï¼‰ï¼IdentityServer ä¼šè‡ªåŠ¨å¸®æ‚¨å…³è”ã€‚

ğŸ¯ 1. åœ¨ API é¡¹ç›®ä¸­éªŒè¯ä»¤ç‰Œæ—¶ä½¿ç”¨

```
// Startup.cs æˆ– Program.cs
services.AddAuthentication("Bearer")
    .AddIdentityServerAuthentication(options =>
    {
        options.Authority = "https://your-identity-server.com";
        options.ApiName = "contactResource";  // â† è¿™é‡Œä½¿ç”¨å¤§æ¥¼åç§°ï¼
        options.RequireHttpsMetadata = false;
    });
```

ä½œç”¨ï¼šå‘Šè¯‰ API åªæ¥å—é’ˆå¯¹"contactResource"è¿™åº§å¤§æ¥¼çš„ä»¤ç‰Œã€‚
ğŸ¯ 2. åœ¨é¢å‘çš„è®¿é—®ä»¤ç‰Œä¸­ä½œä¸º audienceï¼Œ å½“ IdentityServer é¢å‘ä»¤ç‰Œæ—¶ï¼Œä¼šè‡ªåŠ¨åŒ…å«ï¼š

```
{
  "access_token": "eyJhbGciOiJ...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "scope": "contact.read contact.write",
  // ä»¤ç‰Œå†…éƒ¨åŒ…å«ï¼š
  // "aud": "contactResource",    â† å¤§æ¥¼åç§°
  // "scope": "contact.read contact.write"  â† æˆ¿é—´æƒé™
}
```

ğŸ¯ 3. API çš„æƒé™éªŒè¯æµç¨‹

```
// ä¼ªä»£ç è¡¨ç¤ºéªŒè¯è¿‡ç¨‹
public bool ValidateToken(string token)
{
    // 1. æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦æ˜¯ç»™"contactResource"å¤§æ¥¼çš„ï¼Ÿ
    if (token.aud != "contactResource")
    {
        return false; // é”™è¯¯å¤§æ¥¼ï¼Œæ‹’ç»è®¿é—®ï¼
    }

    // 2. æ£€æŸ¥æ˜¯å¦æœ‰è¿›å…¥ç‰¹å®šæˆ¿é—´çš„æƒé™ï¼Ÿ
    if (requiredScope == "contact.read" && !token.scopes.Contains("contact.read"))
    {
        return false; // æ²¡æœ‰è¿™ä¸ªæˆ¿é—´çš„æƒé™ï¼
    }

    return true; // éªŒè¯é€šè¿‡ï¼
}
```

# é‚£æˆ‘åŸºæœ¬ç†è§£äº†ï¼Œæˆ‘è¿™é‡Œä¹‹æ‰€ä»¥ postman å‘é€çš„ scope å‚æ•°æ˜¯å¸¦æœ‰ contact_api çš„è¿™ä¸ªå…¶å® scopeï¼Œè¿™æ—¶å€™æ‹¥æœ‰è¿™ä¸ª scope çš„å¤§æ¥¼æ°å¥½ä¹Ÿå«åš contact_api æˆ‘çš„å¤§æ¥¼éªŒè¯æ°å¥½æ˜¯ä¹Ÿæ˜¯ contact_api ï¼Œæ‰€ä»¥æˆ‘è¿™æ°å¥½æ²¡æœ‰é—®é¢˜äº†

# 4. æˆæƒç­–ç•¥é…ç½® æ˜¯ä»€ä¹ˆ

å°±æ˜¯è¯´ API æ–¹æ³•å¤´ä¸ŠæŒ‡å®šç­–ç•¥ policy

```
[Authorize(Policy = "Contact.Read")] // éœ€è¦è¯»å–æƒé™
public IActionResult GetContacts() { ... }
```

å°±ä¼šåº”ç”¨

```
options.AddPolicy("Contact.Read", policy =>
policy.RequireAssertion(context =>
context.User.HasClaim(c =>
c.Type == "scope" &&
(c.Value == "contact_api" || c.Value == "contact.read" ||
c.Value == "contact.manage" || c.Value == "contact.admin")
)));
```

è¿™ä¸ªç­–ç•¥å®šä¹‰äº†å‘—

# é—®é¢˜ 403

æˆ‘ç°åœ¨å¯¹ Contact.API åšäº†ä¸€äº›æƒé™è®¤è¯çš„æ“ä½œï¼Œ åŒ…æ‹¬ IdentityServer ä¸­çš„ä¿®æ”¹ , ä¸­åŠ äº†ç­–ç•¥æ ‡ç­¾ï¼Œ ä¿®æ”¹äº† Audience åŠ äº†ç­–ç•¥ï¼Œ ç„¶åå‘¢æˆ‘å»è¯·æ±‚äº† tokenï¼Œæ˜¯

```
{

"iss": "https://localhost:5202",

"nbf": 1757027664,

"iat": 1757027664,

"exp": 1757031264,

"aud": [

    "contactResource",

    "gateway_api",

    "user_api"

],

"scope": [

    "contact.read",

    "gateway_api",

    "openid",

    "profile",

    "user_api"

],

"amr": [

    "sms_code"

],

"client_id": "android",

"sub": "3",

"auth_time": 1757027664,

"idp": "local",

"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name": "John Doe",

"name": "John Doe",

"company": "Example Corp",

"title": "Software Engineer",

"avatar": "default.png",

"jti": "DCD158FA4C68B169426E4645D37F6C7E"

}
```

çœ‹è¿”å›çš„ aud æ²¡å•¥é—®é¢˜ æœ‰ contactResourceï¼Œscope ä¹Ÿæœ‰ "contact.read", æˆ‘é‡åˆ°çš„é—®é¢˜æ˜¯ å½“æˆ‘ç”¨è¿™ä¸ª token å»è¯·æ±‚ API çš„æ—¶å€™æŠ¥é”™ 403 å‘¢ï¼Œä½ å¸®æˆ‘åˆ†æä¸€ä¸‹åŸå› å‘—

ç½‘å…³æŠ¥é”™ä¿¡æ¯
ScopeNotAuthorizedError: no one user scope: 'contact.read,gateway_api,openid,profile,user_api' match with some allowed scope: 'contact_api'
Setting error response for request: GET /contacts

# æ–¹æ¡ˆ

è¿™ä¸ªé”™è¯¯æ˜¯ç½‘å…³æŠ¥å‡ºæ¥çš„ï¼Œ
åŸå› æ˜¯ ocelot çš„é…ç½®é—®é¢˜

```
 {
      "DownstreamPathTemplate": "/api/contacts",
      "DownstreamScheme": "https",
      "DownstreamHostAndPorts": [
        {
          "Host": "localhost",
          "Port": 5204
        }
      ],
      "UpstreamPathTemplate": "/contacts",
      "UpstreamHttpMethod": [ "GET" ],
      "AuthenticationOptions": {
        "AuthenticationProviderKey": "finbook"
      },
      "RouteClaimsRequirement": {
        "scope": "contact_api"
      }
    },
```

scope --> contact.read

```
"RouteClaimsRequirement": {
        "scope": "contact.read"
      }
```

# é—®é¢˜ ä¿®æ”¹äº†ä¸€ä¸‹ ocelot.json ä¸æŠ¥ 403 äº†ï¼Œä½†æ˜¯ audience è®¤è¯ä¸è¿‡å»

System.InvalidOperationException: The AuthorizationPolicy named: 'contactResource' was not found.
at Microsoft.AspNetCore.Authorization.AuthorizationPolicy.CombineAsync(IAuthorizationPolicyProvider policyProvider, IEnumerable`1 authorizeData, IEnumerable`1 policies)
at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)

# æ–¹æ¡ˆ

ç­–ç•¥é‡Œéœ€è¦åŠ 

````

options.AddPolicy("contactResource", policy =>
policy.RequireAssertion(context =>
{
  var audienceClaims = context.User.FindAll(c => c.Type == "aud");
  return audienceClaims.Any(c => c.Value == "contactResource");
}));

```


````

# è¿™é‡Œä¸»è¦è®¨è®ºäº† Config.cs ä¸»è¦ clientï¼Œ scope ï¼Œ APIResource çš„å…³ç³»ï¼Œç°åœ¨æˆ‘èƒ½ç†è§£ å‘é€è¯·æ±‚æ—¶å€™å¯ä»¥æ ¹æ®è¯·æ±‚çš„ scope å»å¾—åˆ° Aud æ˜¯ä»€ä¹ˆï¼Œæˆ‘æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘çš„ scope å±äºå¤šä¸ª APIResource å‘¢ï¼Œé‚£æ€ä¹ˆå¾—åˆ° Aud å‘¢

è¿™ä¸ªæˆ‘å€’æ˜¯æ²¡æœ‰éªŒè¯å“ˆï¼Œä¸è¿‡å¾ˆå®¹æ˜“éªŒè¯ï¼

```
// Config.cs
public static IEnumerable<ApiScope> GetApiScopes()
{
    return new List<ApiScope>
    {
        new ApiScope("shared.read", "Shared Read Access"),
        new ApiScope("shared.write", "Shared Write Access")
    };
}

public static IEnumerable<ApiResource> GetApiResources()
{
    return new List<ApiResource>
    {
        new ApiResource("contact_api", "Contact Service")
        {
            Scopes = { "shared.read", "shared.write" }
        },
        new ApiResource("user_api", "User Service")
        {
            Scopes = { "shared.read" }  // åªè¯»æƒé™
        },
        new ApiResource("gateway_api", "Gateway Service")
        {
            Scopes = { "shared.read", "shared.write" }
        }
    };
}
```

# å½“æ‚¨è¯·æ±‚åŒ…å« shared.read scope æ—¶ï¼š

```
# Postman è¯·æ±‚
POST /connect/token
Content-Type: application/x-www-form-urlencoded

client_id=android&
client_secret=secret&
scope=shared.read&
grant_type=client_credentials
```

# é¢å‘çš„ä»¤ç‰Œä¼šåŒ…å« æ‰€æœ‰ç›¸å…³çš„ ApiResource!

```
{
  "access_token": "eyJhbGciOiJ...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "scope": "shared.read",
  // ä»¤ç‰Œå†…éƒ¨ payload:
  "aud": ["contact_api", "user_api", "gateway_api"],  // æ‰€æœ‰ç›¸å…³çš„ ApiResource!
  "scope": ["shared.read"]
}
```
