# å¥½ï¼Œæˆ‘ç°åœ¨çš„çŠ¶æ€æ˜¯ï¼Œä» user.api ä¸­å¯ä»¥å‘é€æ¶ˆæ¯äº†ï¼Œcontact.api ä¸­å¯ä»¥æ¥æ”¶åˆ°æ¶ˆæ¯äº†ï¼Œæˆ‘æœ‰ä¸€äº›é—®é¢˜è¿˜æ˜¯æƒ³è¿›ä¸€æ­¥è®¨è®ºä¸‹ï¼Œæœ‰å…³äºæˆ‘çš„å¾®æœåŠ¡å’Œ RabbitMQ ä¹‹é—´çš„è°ƒç”¨å…³ç³»ï¼Œæˆ‘ç°åœ¨æ˜¯

```
docker run -d --name rabbitmq \

-p 5672:5672 \
 -p 15672:15672 \
 -e RABBITMQ_DEFAULT_USER=admin \
 -e RABBITMQ_DEFAULT_PASS='ACSdev312!@' \
 --restart unless-stopped \
 rabbitmq:3-management
```

è¿™æ ·è¿è¡Œèµ·æ¥ä¸€ä¸ª RabbitMQ çš„å®¹å™¨ï¼Œç„¶åä»£ç ä¸­

```
builder.Services.AddCap(x =>
{
    x.UseEntityFramework<UserContext>();
    var configuration = builder.Configuration;
    x.UseRabbitMQ(option =>
    {
        option.HostName = configuration["RabbitMQ:HostName"];
        option.Port = int.Parse(configuration["RabbitMQ:Port"]);
        option.UserName = configuration["RabbitMQ:UserName"];
        option.Password = configuration["RabbitMQ:Password"];
        option.VirtualHost = configuration["RabbitMQ:VirtualHost"];

            });
            x.FailedRetryCount = 3;
            x.FailedRetryInterval = 60;
            x.UseDashboard(opt =>
            {
                opt.PathMatch = "/cap"; // Dashboardè®¿é—®è·¯å¾„
            });

    });
```

è¿™æ ·æ˜¯å»æ³¨å†Œä½¿ç”¨ RabbitMQï¼Œæˆ‘çš„é—®é¢˜æ˜¯æˆ‘çš„ç›®æ ‡ç³»ç»Ÿæ˜¯éœ€è¦ K8S ä¸­çš„ï¼ŒRabbitMQ æ˜¯ä¸æ˜¯ä¹Ÿä¼š deployment å’Œ Service ç®¡ç†å‘¢ï¼Œå†ç”±æˆ‘çš„å¾®æœåŠ¡è°ƒç”¨å‘¢ï¼Œä¸å¯èƒ½æˆ‘çš„ k8s ç³»ç»Ÿä¸­åªæœ‰ä¸€ä¸ª RabbitMQ å®¹å™¨å‘€ï¼Œä¾›æ‰€æœ‰å¾®æœåŠ¡è°ƒç”¨ï¼Œï¼Œæˆ‘æ˜¯åœ¨è€ƒè™‘ RabbitMQ åœ¨ç³»ç»Ÿæ¶æ„ä¸­çš„å®‰æ’

# æ–¹æ¡ˆ

ä½ çš„æƒ³æ³•æ˜¯å®Œå…¨æ­£ç¡®ä¸”éå¸¸åˆç†çš„ï¼ ğŸ‰

ğŸ¯ RabbitMQ åœ¨ K8s ä¸­çš„æ¶æ„å®‰æ’

1. å½“å‰å•å®¹å™¨æ–¹å¼çš„å±€é™æ€§

- å•ç‚¹æ•…éšœï¼šå®¹å™¨é‡å¯/å´©æºƒä¼šå¯¼è‡´æ‰€æœ‰æ¶ˆæ¯æœåŠ¡ä¸­æ–­

- æ•°æ®ä¸¢å¤±é£é™©ï¼šå®¹å™¨åˆ é™¤æ„å‘³ç€æ¶ˆæ¯æ•°æ®ä¸¢å¤±

- æ€§èƒ½ç“¶é¢ˆï¼šæ‰€æœ‰å¾®æœåŠ¡å…±äº«å•ä¸ªå®ä¾‹ï¼Œå‹åŠ›å¤§

- æ‰©å±•å›°éš¾ï¼šæ— æ³•æ°´å¹³æ‰©å±•

2. K8s ä¸­çš„æ­£ç¡®éƒ¨ç½²æ–¹å¼

## æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ StatefulSet éƒ¨ç½² RabbitMQ é›†ç¾¤ï¼ˆæ¨èï¼‰

```
# rabbitmq-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rabbitmq
  namespace: messaging
spec:
  serviceName: rabbitmq
  replicas: 3  # 3èŠ‚ç‚¹é›†ç¾¤
  selector:
    matchLabels:
      app: rabbitmq
  template:
    metadata:
      labels:
        app: rabbitmq
    spec:
      containers:
      - name: rabbitmq
        image: rabbitmq:3-management
        env:
        - name: RABBITMQ_ERLANG_COOKIE
          value: "secret-cookie"
        - name: RABBITMQ_DEFAULT_USER
          value: "admin"
        - name: RABBITMQ_DEFAULT_PASS
          value: "ACSdev312!@"
        ports:
        - containerPort: 5672
          name: amqp
        - containerPort: 15672
          name: management
        volumeMounts:
        - name: rabbitmq-data
          mountPath: /var/lib/rabbitmq
  volumeClaimTemplates:
  - metadata:
      name: rabbitmq-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: "standard"
      resources:
        requests:
          storage: 10Gi
```

3. å¯¹åº”çš„ Service é…ç½®

```
# rabbitmq-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: rabbitmq
  namespace: messaging
spec:
  clusterIP: None  # Headless Serviceï¼Œç”¨äºStatefulSet
  ports:
  - port: 5672
    targetPort: 5672
    name: amqp
  - port: 15672
    targetPort: 15672
    name: management
  selector:
    app: rabbitmq
---
# å¤–éƒ¨è®¿é—®Serviceï¼ˆå¦‚æœéœ€è¦ï¼‰
apiVersion: v1
kind: Service
metadata:
  name: rabbitmq-external
  namespace: messaging
spec:
  type: LoadBalancer
  ports:
  - port: 5672
    targetPort: 5672
    name: amqp
  - port: 15672
    targetPort: 15672
    name: management
  selector:
    app: rabbitmq
```

4. å¾®æœåŠ¡è¿æ¥é…ç½®
   åœ¨ K8s ç¯å¢ƒä¸­çš„é…ç½®

```
builder.Services.AddCap(x =>
{
    x.UseEntityFramework<UserContext>();
    x.UseRabbitMQ(option =>
    {
        // ä½¿ç”¨K8s Serviceåç§°è¿›è¡ŒæœåŠ¡å‘ç°
        option.HostName = "rabbitmq.messaging.svc.cluster.local"; // K8så†…éƒ¨DNS
        option.Port = 5672;
        option.UserName = "admin";
        option.Password = "ACSdev312!@";
        option.VirtualHost = "/";
    });
    x.FailedRetryCount = 3;
    x.FailedRetryInterval = 60;
    x.UseDashboard(opt => { opt.PathMatch = "/cap"; });
});
```

é…ç½®åˆ° appsettings.json

```
{
  "RabbitMQ": {
    "HostName": "rabbitmq.messaging.svc.cluster.local",
    "Port": 5672,
    "UserName": "admin",
    "Password": "ACSdev312!@",
    "VirtualHost": "/"
  }
}
```

# å¥½å˜ï¼Œæˆ‘å¤§æ¦‚å¯ä»¥çœ‹æ‡‚ä½ æä¾›çš„æ–¹æ¡ˆäº†ï¼Œdeployment å’Œ Service çš„é…ç½®ï¼Œè¿™æ˜¯ K8s çš„æ¦‚å¿µè¿ç”¨äº†ï¼Œä¹‹åæˆ‘ä¼šå†å­¦ä¹ ä¸€ä¸‹ K8s çš„åŸºç¡€çŸ¥è¯†ï¼Œ

å¤ªæ£’äº†ï¼ğŸ‘ ä½ çš„å­¦ä¹ è·¯å¾„éå¸¸æ¸…æ™°å’Œæ­£ç¡®ï¼
