# EventBus ä»£ç æ€»ä½“å·¥ä½œæµç¨‹

æ€»ç»“ï¼šå®Œæ•´çš„æ³¨å†Œæµç¨‹

é…ç½®è¿æ¥ â†’ åˆ›å»ºåˆ° RabbitMQ/Service Bus çš„æŒä¹…è¿æ¥

æ³¨å†ŒæœåŠ¡ â†’ å°† EventBus å®ç°ã€è®¢é˜…ç®¡ç†å™¨ã€äº‹ä»¶å¤„ç†å™¨æ³¨å†Œåˆ° DI å®¹å™¨

åˆ›å»ºé€šé“ â†’ EventBus åˆå§‹åŒ–æ—¶åˆ›å»º RabbitMQ é€šé“ã€äº¤æ¢æœºã€é˜Ÿåˆ—

è®¢é˜…äº‹ä»¶ â†’ åº”ç”¨å¯åŠ¨æ—¶å»ºç«‹äº‹ä»¶-å¤„ç†å™¨çš„æ˜ å°„å…³ç³»

å»ºç«‹ç»‘å®š â†’ åœ¨ RabbitMQ ä¸­å»ºç«‹é˜Ÿåˆ—-äº¤æ¢æœºçš„ç»‘å®šå…³ç³»

å¼€å§‹ç›‘å¬ â†’ å¯åŠ¨æ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œç­‰å¾…äº‹ä»¶åˆ°æ¥

å„ä¸ªå¾®æœåŠ¡ç¡®å®šè‡ªå·±çš„é˜Ÿåˆ—ï¼Œéƒ½åœ¨è¿™ä¸ªå•ä¸ªé˜Ÿåˆ—æ¥æ”¶ä¿¡æ¯

# è®¾è®¡æ¨¡å¼çš„ä½“ç°

è¿™å®é™…ä¸Šæ˜¯ä¸­ä»‹è€…æ¨¡å¼ï¼ˆMediator Patternï¼‰ çš„å…¸å‹åº”ç”¨ï¼š

EventBus ä½œä¸ºä¸­ä»‹è€…

\_handlers ä½œä¸ºè·¯ç”±è¡¨

äº‹ä»¶å‘å¸ƒè€…ä¸çŸ¥é“è°å¤„ç†äº‹ä»¶

äº‹ä»¶å¤„ç†å™¨ä¸çŸ¥é“è°å‘å¸ƒäº†äº‹ä»¶

# è§£è€¦æ•ˆæœï¼š

```
// å‘å¸ƒè€…åªéœ€è¦å…³å¿ƒå‘å¸ƒäº‹ä»¶
_eventBus.Publish(new ProductPriceChangedIntegrationEvent(...));

// å¤„ç†å™¨åªéœ€è¦å…³å¿ƒå¤„ç†äº‹ä»¶
public class InventoryServiceHandler : IIntegrationEventHandler<ProductPriceChangedIntegrationEvent>
{
    public Task Handle(ProductPriceChangedIntegrationEvent @event)
    {
        // å¤„ç†é€»è¾‘...
    }
}
```

#

// Autofac
using (var scope = \_lifetimeScope.BeginLifetimeScope())
{
var service = scope.Resolve<IMyService>();
}

// å†…ç½® DI
using (var scope = \_serviceProvider.CreateScope())
{
var service = scope.ServiceProvider.GetService<IMyService>();
} æˆ‘ç°åœ¨å°±æ˜¯æƒ³ç†è§£ä¸‹è¿™ä¸¤ä¸ªçš„åŒºåˆ«

# æ¶‰åŠæ€æƒ³æ€»ç»“:

1. è®¢é˜…æ—¶å»ºç«‹æ˜ å°„å…³ç³»

```
// è¿™ä¸¤ä¸ªè°ƒç”¨éƒ½åœ¨åšåŒä¸€ä»¶äº‹ï¼šå‘Šè¯‰ EventBus "å½“ ProductPriceChangedIntegrationEvent å‘ç”Ÿæ—¶..."
eventBus.SubscribeDynamic<UniversalLoggerEventHandler>("ProductPriceChangedIntegrationEvent");
eventBus.Subscribe<ProductPriceChangedIntegrationEvent, ProductPriceChangedIntegrationEventHandler>();

// å®ƒä»¬åœ¨ _handlers å­—å…¸ä¸­åˆ›å»ºäº†è¿™æ ·çš„æ˜ å°„ï¼š
// "ProductPriceChangedIntegrationEvent" ->
//     [UniversalLoggerEventHandler, ProductPriceChangedIntegrationEventHandler]
```

2. å‘å¸ƒæ—¶å®Œå…¨è§£è€¦

```
// ä¸šåŠ¡ä»£ç åªéœ€è¦å…³å¿ƒå‘å¸ƒäº‹ä»¶ï¼Œå®Œå…¨ä¸çŸ¥é“è°ä¼šå¤„ç†
public void UpdateProductPrice(int productId, decimal newPrice)
{
    // ä¸šåŠ¡é€»è¾‘...

    // å‘å¸ƒäº‹ä»¶ï¼šæˆ‘åªå…³å¿ƒ"å‘ç”Ÿäº†ä»€ä¹ˆ"ï¼Œä¸å…³å¿ƒ"è°æ¥å¤„ç†"
    var @event = new ProductPriceChangedIntegrationEvent(productId, oldPrice, newPrice);
    _eventBus.Publish(@event);  // ğŸš€ å‘å°„äº‹ä»¶ï¼Œç„¶åå°±ä¸ç”¨ç®¡äº†
}
```

3. EventBus è‡ªåŠ¨è·¯ç”±

```
// EventBus å†…éƒ¨è‡ªåŠ¨å¤„ç†æ‰€æœ‰è·¯ç”±é€»è¾‘
private async Task ProcessEvent(string eventName, string message)
{
    // è‡ªåŠ¨æŸ¥æ‰¾æ‰€æœ‰è®¢é˜…è€…
    var subscriptions = _subsManager.GetHandlersForEvent(eventName);

    // è‡ªåŠ¨è°ƒç”¨æ‰€æœ‰å¤„ç†å™¨
    foreach (var subscription in subscriptions)
    {
        // è‡ªåŠ¨åˆ›å»ºå¤„ç†å™¨å®ä¾‹
        // è‡ªåŠ¨ååºåˆ—åŒ–æ¶ˆæ¯
        // è‡ªåŠ¨è°ƒç”¨ Handle æ–¹æ³•
    }
}
```

# è¿™å°±æ˜¯"äº‹ä»¶é©±åŠ¨æ¶æ„"çš„é­…åŠ›ï¼

å‘å¸ƒè€…å®Œå…¨è§£è€¦

```
// å‘å¸ƒè€…åªéœ€è¦çŸ¥é“"å‘ç”Ÿäº†ä»€ä¹ˆäº‹ä»¶"
// å®Œå…¨ä¸çŸ¥é“ä¹Ÿä¸å…³å¿ƒï¼š
// - æœ‰å¤šå°‘ä¸ªå¤„ç†å™¨
// - å¤„ç†å™¨æ˜¯ä»€ä¹ˆç±»å‹ï¼ˆåŠ¨æ€/å¼ºç±»å‹ï¼‰
// - å¤„ç†å™¨åœ¨å“ªé‡Œè¿è¡Œ
// - å¤„ç†å™¨å¦‚ä½•å®ç°

_eventBus.Publish(new ProductPriceChangedIntegrationEvent(...));

```

å¤„ç†å™¨ä¸“æ³¨å•ä¸€èŒè´£

```
// æ¯ä¸ªå¤„ç†å™¨åªå…³å¿ƒè‡ªå·±çš„èŒè´£
public class UniversalLoggerEventHandler : IDynamicIntegrationEventHandler
{
    // æˆ‘åªå…³å¿ƒï¼šè®°å½•æ‰€æœ‰äº‹ä»¶çš„é€šç”¨ä¿¡æ¯
}

public class ProductPriceChangedIntegrationEventHandler
    : IIntegrationEventHandler<ProductPriceChangedIntegrationEvent>
{
    // æˆ‘åªå…³å¿ƒï¼šå¤„ç†äº§å“ä»·æ ¼å˜æ›´çš„ä¸šåŠ¡é€»è¾‘
}

public class InventoryUpdateEventHandler
    : IIntegrationEventHandler<ProductPriceChangedIntegrationEvent>
{
    // æˆ‘åªå…³å¿ƒï¼šæ›´æ–°åº“å­˜
}

// å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„å¤„ç†å™¨ï¼Œå®Œå…¨ä¸å½±å“ç°æœ‰ä»£ç 
```

ç³»ç»Ÿçš„å¯æ‰©å±•æ€§

```
// æœªæ¥å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„å¤„ç†å™¨ï¼Œæ¯”å¦‚ï¼š
public class PriceChangeAnalyticsEventHandler
    : IIntegrationEventHandler<ProductPriceChangedIntegrationEvent>
{
    // æ–°å¢ï¼šä»·æ ¼å˜æ›´åˆ†æ
}

public class CustomerNotificationEventHandler
    : IIntegrationEventHandler<ProductPriceChangedIntegrationEvent>
{
    // æ–°å¢ï¼šå®¢æˆ·é€šçŸ¥
}

// æ·»åŠ æ–¹å¼ï¼šåªéœ€è¦è®¢é˜…ï¼Œå‘å¸ƒè€…ä»£ç å®Œå…¨ä¸ç”¨ä¿®æ”¹
eventBus.Subscribe<ProductPriceChangedIntegrationEvent, PriceChangeAnalyticsEventHandler>();
eventBus.Subscribe<ProductPriceChangedIntegrationEvent, CustomerNotificationEventHandler>();
```

# å®é™…é¡¹ç›®ä¸­çš„å¨åŠ›

å¾®æœåŠ¡åœºæ™¯

```
// è®¢å•æœåŠ¡å‘å¸ƒäº‹ä»¶
public class OrderService
{
    public void CreateOrder(Order order)
    {
        // åˆ›å»ºè®¢å•é€»è¾‘...
        _eventBus.Publish(new OrderCreatedIntegrationEvent(order.Id));
        // è®¢å•æœåŠ¡åªå…³å¿ƒåˆ›å»ºè®¢å•ï¼Œä¸å…³å¿ƒå…¶ä»–æœåŠ¡æ€ä¹ˆååº”
    }
}

// å¤šä¸ªæœåŠ¡å¯ä»¥ç‹¬ç«‹è®¢é˜…è¿™ä¸ªäº‹ä»¶
```

åˆ†å¸ƒå¼ç³»ç»Ÿ

```
// æœåŠ¡Aï¼ˆ.NETï¼‰å‘å¸ƒäº‹ä»¶
_eventBus.Publish(new DataUpdatedIntegrationEvent(data));

// æœåŠ¡Bï¼ˆJavaï¼‰å¯ä»¥è®¢é˜…å¤„ç†
// æœåŠ¡Cï¼ˆPythonï¼‰ä¹Ÿå¯ä»¥è®¢é˜…å¤„ç†
// æœåŠ¡Dï¼ˆGoï¼‰è¿˜å¯ä»¥è®¢é˜…å¤„ç†

// æ‰€æœ‰æœåŠ¡é€šè¿‡æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆRabbitMQï¼‰è§£è€¦
```

# æˆ‘è™½ç„¶å¤§ä½“ç†è§£äº† è®¾è®¡çš„åŸç†ï¼Œä½†æ˜¯å…·ä½“åº”ç”¨è¿˜æ˜¯æœ‰å·®è·ã€‚æˆ‘æƒ³ç»§ç»­äº†è§£ä¸€ä¸‹ï¼Œåº”ç”¨åœºæ™¯å‘€ï¼Œä½ æåˆ°çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ¦‚å¿µæˆ‘å…ˆæ”¾ä¸€ä¸‹ä¹‹åå†è®¨è®ºï¼Œä¸åŒå¾®æœåŠ¡ä¹‹é—´æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Œå¦‚ä½•å‘å¸ƒæ¶ˆæ¯ï¼Œå¦‚ä½•è®¢é˜…è¿™ä¸ªæ¶ˆæ¯ï¼Œå¦‚ä½•æ¥å—æ¶ˆæ¯
