# æˆ‘è™½ç„¶å¤§ä½“ç†è§£äº† è®¾è®¡çš„åŸç†ï¼Œä½†æ˜¯å…·ä½“åº”ç”¨è¿˜æ˜¯æœ‰å·®è·ã€‚æˆ‘æƒ³ç»§ç»­äº†è§£ä¸€ä¸‹ï¼Œåº”ç”¨åœºæ™¯å‘€ï¼Œä½ æåˆ°çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ¦‚å¿µæˆ‘å…ˆæ”¾ä¸€ä¸‹ä¹‹åå†è®¨è®ºï¼Œä¸åŒå¾®æœåŠ¡ä¹‹é—´æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Œå¦‚ä½•å‘å¸ƒæ¶ˆæ¯ï¼Œå¦‚ä½•è®¢é˜…è¿™ä¸ªæ¶ˆæ¯ï¼Œå¦‚ä½•æ¥å—æ¶ˆæ¯

# å¾®æœåŠ¡é—´é€šä¿¡çš„å®Œæ•´æµç¨‹

åœºæ™¯ï¼šç”µå•†ç³»ç»Ÿä¸­çš„è®¢å•åˆ›å»º
å‡è®¾æˆ‘ä»¬æœ‰ä¸‰ä¸ªå¾®æœåŠ¡ï¼š

OrderServiceï¼ˆè®¢å•æœåŠ¡ï¼‰

InventoryServiceï¼ˆåº“å­˜æœåŠ¡ï¼‰

NotificationServiceï¼ˆé€šçŸ¥æœåŠ¡ï¼‰

1. é¡¹ç›®ç»“æ„å’Œå…±äº«å¥‘çº¦
   å…±äº«ç±»åº“ï¼ˆå¯é€‰ä½†æ¨è

```

// Shared.Contracts/Events/OrderCreatedIntegrationEvent.cs
namespace Shared.Contracts.Events
{
    public class OrderCreatedIntegrationEvent : IntegrationEvent
    {
        public int OrderId { get; set; }
        public string CustomerId { get; set; }
        public DateTime OrderDate { get; set; }
        public List<OrderItem> Items { get; set; } = new();
        public decimal TotalAmount { get; set; }

        public OrderCreatedIntegrationEvent(int orderId, string customerId, DateTime orderDate, decimal totalAmount)
        {
            OrderId = orderId;
            CustomerId = customerId;
            OrderDate = orderDate;
            TotalAmount = totalAmount;
        }
    }

    public class OrderItem
    {
        public int ProductId { get; set; }
        public string ProductName { get; set; } = string.Empty;
        public int Quantity { get; set; }
        public decimal UnitPrice { get; set; }
    }
}
```

2. OrderServiceï¼ˆå‘å¸ƒè€…
   å‘å¸ƒäº‹ä»¶çš„ä¸šåŠ¡ä»£ç 

```
// OrderService/Application/Commands/CreateOrderCommandHandler.cs
public class CreateOrderCommandHandler : IRequestHandler<CreateOrderCommand, int>
{
    private readonly IOrderRepository _orderRepository;
    private readonly IEventBus _eventBus;
    private readonly ILogger<CreateOrderCommandHandler> _logger;

    public CreateOrderCommandHandler(
        IOrderRepository orderRepository,
        IEventBus eventBus,
        ILogger<CreateOrderCommandHandler> logger)
    {
        _orderRepository = orderRepository;
        _eventBus = eventBus;
        _logger = logger;
    }

    public async Task<int> Handle(CreateOrderCommand request, CancellationToken cancellationToken)
    {
        _logger.LogInformation("å¼€å§‹åˆ›å»ºè®¢å• - å®¢æˆ·: {CustomerId}", request.CustomerId);

        // 1. åˆ›å»ºè®¢å•å®ä½“
        var order = new Order
        {
            CustomerId = request.CustomerId,
            OrderDate = DateTime.UtcNow,
            Status = OrderStatus.Pending,
            Items = request.Items.Select(item => new OrderItem
            {
                ProductId = item.ProductId,
                ProductName = item.ProductName,
                Quantity = item.Quantity,
                UnitPrice = item.UnitPrice
            }).ToList()
        };

        // 2. ä¿å­˜è®¢å•åˆ°æ•°æ®åº“
        await _orderRepository.AddAsync(order);
        await _orderRepository.SaveChangesAsync();

        _logger.LogInformation("è®¢å•åˆ›å»ºæˆåŠŸ - è®¢å•ID: {OrderId}", order.Id);

        // 3. å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
        var orderCreatedEvent = new OrderCreatedIntegrationEvent(
            orderId: order.Id,
            customerId: order.CustomerId,
            orderDate: order.OrderDate,
            totalAmount: order.Items.Sum(item => item.Quantity * item.UnitPrice)
        )
        {
            Items = order.Items.Select(item => new Shared.Contracts.Events.OrderItem
            {
                ProductId = item.ProductId,
                ProductName = item.ProductName,
                Quantity = item.Quantity,
                UnitPrice = item.UnitPrice
            }).ToList()
        };

        _eventBus.Publish(orderCreatedEvent);

        _logger.LogInformation("è®¢å•åˆ›å»ºäº‹ä»¶å·²å‘å¸ƒ - è®¢å•ID: {OrderId}", order.Id);

        return order.Id;
    }
}
```

OrderService çš„ Startup é…ç½®

```

// OrderService/Startup.cs
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        // æ³¨å†Œ EventBusï¼ˆåªå‘å¸ƒï¼Œä¸è®¢é˜…ï¼‰
        services.AddSingleton<IRabbitMQPersistentConnection>(sp =>
        {
            var logger = sp.GetRequiredService<ILogger<DefaultRabbitMQPersistentConnection>>();
            var factory = new ConnectionFactory()
            {
                HostName = Configuration["RabbitMQ:Host"],
                UserName = Configuration["RabbitMQ:Username"],
                Password = Configuration["RabbitMQ:Password"],
                DispatchConsumersAsync = true
            };
            return new DefaultRabbitMQPersistentConnection(factory, logger);
        });

        services.AddSingleton<IEventBus, EventBusRabbitMQ>(sp =>
        {
            var rabbitMQConnection = sp.GetRequiredService<IRabbitMQPersistentConnection>();
            var logger = sp.GetRequiredService<ILogger<EventBusRabbitMQ>>();
            var subsManager = sp.GetRequiredService<IEventBusSubscriptionsManager>();

            return new EventBusRabbitMQ(rabbitMQConnection, logger, subsManager,
                queueName: "order_service", retryCount: 5);
        });

        services.AddSingleton<IEventBusSubscriptionsManager, InMemoryEventBusSubscriptionsManager>();

        // å…¶ä»–æœåŠ¡æ³¨å†Œ...
    }
}
```

3. InventoryServiceï¼ˆè®¢é˜…è€…ï¼‰
   è®¢é˜…å’Œå¤„ç†äº‹ä»¶

```

// InventoryService/Application/EventHandlers/OrderCreatedIntegrationEventHandler.cs
public class OrderCreatedIntegrationEventHandler
    : IIntegrationEventHandler<OrderCreatedIntegrationEvent>
{
    private readonly IInventoryRepository _inventoryRepository;
    private readonly ILogger<OrderCreatedIntegrationEventHandler> _logger;

    public OrderCreatedIntegrationEventHandler(
        IInventoryRepository inventoryRepository,
        ILogger<OrderCreatedIntegrationEventHandler> logger)
    {
        _inventoryRepository = inventoryRepository;
        _logger = logger;
    }

    public async Task Handle(OrderCreatedIntegrationEvent @event)
    {
        _logger.LogInformation("æ”¶åˆ°è®¢å•åˆ›å»ºäº‹ä»¶ - è®¢å•ID: {OrderId}, å•†å“æ•°é‡: {ItemCount}",
            @event.OrderId, @event.Items.Count);

        try
        {
            // 1. æ£€æŸ¥åº“å­˜
            foreach (var item in @event.Items)
            {
                var inventory = await _inventoryRepository.GetByProductIdAsync(item.ProductId);
                if (inventory == null || inventory.Quantity < item.Quantity)
                {
                    _logger.LogWarning("åº“å­˜ä¸è¶³ - äº§å“ID: {ProductId}, éœ€è¦: {Required}, å®é™…: {Actual}",
                        item.ProductId, item.Quantity, inventory?.Quantity ?? 0);

                    // å¯ä»¥å‘å¸ƒåº“å­˜ä¸è¶³äº‹ä»¶
                    // await _eventBus.Publish(new InventoryInsufficientIntegrationEvent(...));
                    return;
                }
            }

            // 2. æ‰£å‡åº“å­˜
            foreach (var item in @event.Items)
            {
                await _inventoryRepository.ReduceInventoryAsync(item.ProductId, item.Quantity);
                _logger.LogInformation("åº“å­˜æ‰£å‡æˆåŠŸ - äº§å“ID: {ProductId}, æ•°é‡: {Quantity}",
                    item.ProductId, item.Quantity);
            }

            _logger.LogInformation("åº“å­˜å¤„ç†å®Œæˆ - è®¢å•ID: {OrderId}", @event.OrderId);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "å¤„ç†è®¢å•åˆ›å»ºäº‹ä»¶å¤±è´¥ - è®¢å•ID: {OrderId}", @event.OrderId);
            throw;
        }
    }
}
```

InventoryService çš„ Startup é…ç½®

```
// InventoryService/Startup.cs
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        // æ³¨å†Œ EventBusï¼ˆæ—¢å‘å¸ƒä¹Ÿè®¢é˜…ï¼‰
        services.AddSingleton<IRabbitMQPersistentConnection>(sp =>
        {
            var logger = sp.GetRequiredService<ILogger<DefaultRabbitMQPersistentConnection>>();
            var factory = new ConnectionFactory()
            {
                HostName = Configuration["RabbitMQ:Host"],
                UserName = Configuration["RabbitMQ:Username"],
                Password = Configuration["RabbitMQ:Password"],
                DispatchConsumersAsync = true
            };
            return new DefaultRabbitMQPersistentConnection(factory, logger);
        });

        services.AddSingleton<IEventBus, EventBusRabbitMQ>(sp =>
        {
            var rabbitMQConnection = sp.GetRequiredService<IRabbitMQPersistentConnection>();
            var logger = sp.GetRequiredService<ILogger<EventBusRabbitMQ>>();
            var subsManager = sp.GetRequiredService<IEventBusSubscriptionsManager>();

            return new EventBusRabbitMQ(rabbitMQConnection, logger, subsManager,
                queueName: "inventory_service", retryCount: 5);
        });

        services.AddSingleton<IEventBusSubscriptionsManager, InMemoryEventBusSubscriptionsManager>();

        // æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
        services.AddTransient<OrderCreatedIntegrationEventHandler>();

        // å…¶ä»–æœåŠ¡æ³¨å†Œ...
    }

    public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
    {
        // ... å…¶ä»–é…ç½®

        // è®¢é˜…äº‹ä»¶
        var eventBus = app.ApplicationServices.GetRequiredService<IEventBus>();
        eventBus.Subscribe<OrderCreatedIntegrationEvent, OrderCreatedIntegrationEventHandler>();

        _logger.LogInformation("åº“å­˜æœåŠ¡å·²è®¢é˜… OrderCreatedIntegrationEvent");
    }
}
```

4. NotificationServiceï¼ˆå¦ä¸€ä¸ªè®¢é˜…è€…ï¼‰
   è®¢é˜…å’Œå¤„ç†äº‹ä»¶

```
// NotificationService/Application/EventHandlers/OrderCreatedIntegrationEventHandler.cs
public class OrderCreatedIntegrationEventHandler
    : IIntegrationEventHandler<OrderCreatedIntegrationEvent>
{
    private readonly IEmailService _emailService;
    private readonly ISmsService _smsService;
    private readonly ILogger<OrderCreatedIntegrationEventHandler> _logger;

    public OrderCreatedIntegrationEventHandler(
        IEmailService emailService,
        ISmsService smsService,
        ILogger<OrderCreatedIntegrationEventHandler> logger)
    {
        _emailService = emailService;
        _smsService = smsService;
        _logger = logger;
    }

    public async Task Handle(OrderCreatedIntegrationEvent @event)
    {
        _logger.LogInformation("å‘é€è®¢å•åˆ›å»ºé€šçŸ¥ - è®¢å•ID: {OrderId}, å®¢æˆ·: {CustomerId}",
            @event.OrderId, @event.CustomerId);

        try
        {
            // 1. å‘é€é‚®ä»¶é€šçŸ¥
            await _emailService.SendOrderConfirmationAsync(@event.CustomerId, @event.OrderId, @event.TotalAmount);
            _logger.LogInformation("è®¢å•ç¡®è®¤é‚®ä»¶å·²å‘é€ - è®¢å•ID: {OrderId}", @event.OrderId);

            // 2. å‘é€çŸ­ä¿¡é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
            await _smsService.SendOrderNotificationAsync(@event.CustomerId, @event.OrderId);
            _logger.LogInformation("è®¢å•é€šçŸ¥çŸ­ä¿¡å·²å‘é€ - è®¢å•ID: {OrderId}", @event.OrderId);

        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "å‘é€è®¢å•é€šçŸ¥å¤±è´¥ - è®¢å•ID: {OrderId}", @event.OrderId);
            // æ³¨æ„ï¼šé€šçŸ¥å¤±è´¥ä¸åº”è¯¥å½±å“è®¢å•åˆ›å»ºæµç¨‹
        }
    }
}
```

NotificationService çš„ Startup é…ç½®

```
// NotificationService/Startup.cs
public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    // ... å…¶ä»–é…ç½®

    // è®¢é˜…äº‹ä»¶
    var eventBus = app.ApplicationServices.GetRequiredService<IEventBus>();
    eventBus.Subscribe<OrderCreatedIntegrationEvent, OrderCreatedIntegrationEventHandler>();

    _logger.LogInformation("é€šçŸ¥æœåŠ¡å·²è®¢é˜… OrderCreatedIntegrationEvent");
}
```

# å®Œæ•´çš„æ•°æ®æµ

1. äº‹ä»¶å‘å¸ƒæµç¨‹
   ![alt text](../0.å‘å¸ƒè®¢é˜…æµç¨‹.png)

2. RabbitMQ ä¸­çš„å®é™…ç»“æ„

```
Exchange: event_bus (Directç±»å‹)

é˜Ÿåˆ—ç»‘å®š:
- order_service é˜Ÿåˆ—: æ— ç»‘å®šï¼ˆåªç”¨äºå‘å¸ƒï¼‰
- inventory_service é˜Ÿåˆ—: ç»‘å®šåˆ° routing_key "OrderCreatedIntegrationEvent"
- notification_service é˜Ÿåˆ—: ç»‘å®šåˆ° routing_key "OrderCreatedIntegrationEvent"

æ¶ˆæ¯æµå‘:
OrderService â†’ event_bus Exchange â†’ æ ¹æ®routing_keyæŠ•é€’ â†’ inventory_service + notification_service
```

3. å…³é”®è®¾è®¡è¦ç‚¹
   æ¯ä¸ªæœåŠ¡ç‹¬ç«‹çš„é˜Ÿåˆ—

```
// æ¯ä¸ªå¾®æœåŠ¡æœ‰è‡ªå·±çš„é˜Ÿåˆ—åç§°
new EventBusRabbitMQ(..., queueName: "order_service", ...)      // OrderService
new EventBusRabbitMQ(..., queueName: "inventory_service", ...)  // InventoryService
new EventBusRabbitMQ(..., queueName: "notification_service", ...) // NotificationService
```

# æˆ‘ç°åœ¨æœ‰å¾ˆå¤šç–‘é—®ï¼Œ å…³äº 2. RabbitMQ ä¸­çš„å®é™…ç»“æ„ï¼Œå±äº åº•å±‚é€šä¿¡çš„è¿‡ç¨‹äº†ï¼Œå‘å¸ƒè€…å¦‚ä½•å‘å¸ƒå‡ºå»çš„ï¼Œå‘å¸ƒè€…ä¸éœ€è¦å…³æ³¨å„ç§é˜Ÿåˆ—å—ï¼Œä»¥åŠè®¢é˜…è€… 3. å…³é”®è®¾è®¡è¦ç‚¹ æ¯ä¸ªæœåŠ¡ç‹¬ç«‹çš„é˜Ÿåˆ— è¿™äº›ï¼Œè¯·ç»™æˆ‘ä¸€äº›ä»‹ç»

ä½ é—®åˆ°äº† EventBus è®¾è®¡çš„æ ¸å¿ƒé—®é¢˜ã€‚è®©æˆ‘è¯¦ç»†è§£é‡Š RabbitMQ åº•å±‚é€šä¿¡æœºåˆ¶å’Œé˜Ÿåˆ—è®¾è®¡åŸç†ã€‚

1. RabbitMQ åº•å±‚é€šä¿¡ç»“æ„

![alt text](../1.å‘å¸ƒè®¢é˜…åº•å±‚ç†è§£.png)

## åœ¨ EventBus ä¸­çš„å…·ä½“å®ç°

```
public class EventBusRabbitMQ
{
    const string BROKER_NAME = "event_bus";  // Exchange åç§°

    public void Publish(IntegrationEvent @event)
    {
        using (var channel = _persistentConnection.CreateModel())
        {
            // 1. å£°æ˜ Exchangeï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            channel.ExchangeDeclare(
                exchange: BROKER_NAME,
                type: "direct",          // Direct ç±»å‹ï¼šç²¾ç¡®åŒ¹é… routingKey
                durable: true,           // æŒä¹…åŒ–
                autoDelete: false);      // ä¸è‡ªåŠ¨åˆ é™¤

            // 2. å‘å¸ƒæ¶ˆæ¯åˆ° Exchange
            channel.BasicPublish(
                exchange: BROKER_NAME,           // å‘å¸ƒåˆ° event_bus Exchange
                routingKey: @event.GetType().Name, // è·¯ç”±é”® = äº‹ä»¶ç±»å‹åç§°
                mandatory: true,
                basicProperties: properties,
                body: body);  // åºåˆ—åŒ–åçš„äº‹ä»¶æ•°æ®
        }
    }
}
```

2. å‘å¸ƒè€…å¦‚ä½•å‘å¸ƒï¼ˆä¸éœ€è¦å…³å¿ƒé˜Ÿåˆ—ï¼‰
   å‘å¸ƒè€…çš„è§†è§’ï¼šéå¸¸ç®€å•ï¼

```
public class OrderService
{
    private readonly IEventBus _eventBus;

    public async Task CreateOrderAsync()
    {
        // ä¸šåŠ¡é€»è¾‘...

        // å‘å¸ƒäº‹ä»¶ï¼šåªéœ€è¦è¿™ä¸€è¡Œä»£ç ï¼
        _eventBus.Publish(new OrderCreatedIntegrationEvent(orderId, customerId, items));

        // å‘å¸ƒè€…å®Œå…¨ä¸çŸ¥é“ï¼š
        // - æœ‰å¤šå°‘è®¢é˜…è€…
        // - è®¢é˜…è€…æ˜¯è°
        // - æ¶ˆæ¯æ€ä¹ˆè·¯ç”±
        // - æœ‰å“ªäº›é˜Ÿåˆ—
    }
}
```

EventBus å†…éƒ¨å¦‚ä½•å·¥ä½œ

```
public void Publish(IntegrationEvent @event)
{
    // å‘å¸ƒè€…åªéœ€è¦çŸ¥é“ï¼š
    // 1. äº‹ä»¶ç±»å‹ï¼ˆå†³å®šäº† routingKeyï¼‰
    // 2. äº‹ä»¶æ•°æ®

    // EventBus å†…éƒ¨å¤„ç†æ‰€æœ‰å¤æ‚é€»è¾‘ï¼š
    // 1. åºåˆ—åŒ–äº‹ä»¶
    // 2. è¿æ¥åˆ° RabbitMQ
    // 3. å‘å¸ƒåˆ° Exchange
    // 4. é”™è¯¯å¤„ç†å’Œé‡è¯•

    // å‘å¸ƒè€…å®Œå…¨ä¸ç”¨å…³å¿ƒé˜Ÿåˆ—ï¼
}
```

3. æ¯ä¸ªæœåŠ¡ç‹¬ç«‹çš„é˜Ÿåˆ—è®¾è®¡
   ä¸ºä»€ä¹ˆéœ€è¦ç‹¬ç«‹é˜Ÿåˆ—ï¼Ÿ

```
// âŒ é”™è¯¯çš„åšæ³•ï¼šæ‰€æœ‰æœåŠ¡å…±äº«ä¸€ä¸ªé˜Ÿåˆ—
// é—®é¢˜ï¼šå¦‚æœä¸€ä¸ªæœåŠ¡å¤„ç†æ…¢ï¼Œä¼šå½±å“å…¶ä»–æœåŠ¡
// é—®é¢˜ï¼šæ— æ³•ç‹¬ç«‹æ‰©å±•æœåŠ¡

// âœ… æ­£ç¡®çš„åšæ³•ï¼šæ¯ä¸ªæœåŠ¡æœ‰è‡ªå·±çš„é˜Ÿåˆ—
new EventBusRabbitMQ(..., queueName: "order_service", ...)      // OrderService
new EventBusRabbitMQ(..., queueName: "inventory_service", ...)  // InventoryService
new EventBusRabbitMQ(..., queueName: "notification_service", ...) // NotificationService
```

é˜Ÿåˆ—åˆ›å»ºçš„å®Œæ•´æµç¨‹

```
private IModel CreateConsumerChannel()
{
    var channel = _persistentConnection.CreateModel();

    // 1. å£°æ˜ Exchange
    channel.ExchangeDeclare(
        exchange: BROKER_NAME,
        type: "direct",
        durable: true,
        autoDelete: false);

    // 2. å£°æ˜é˜Ÿåˆ—ï¼ˆæ¯ä¸ªæœåŠ¡ç‹¬æœ‰çš„é˜Ÿåˆ—ï¼‰
    channel.QueueDeclare(
        queue: _queueName,           // é˜Ÿåˆ—åç§°ï¼Œå¦‚ "inventory_service"
        durable: true,               // æŒä¹…åŒ–ï¼šæœåŠ¡é‡å¯åé˜Ÿåˆ—ä¸ä¸¢å¤±
        exclusive: false,            // éæ’ä»–ï¼šå…è®¸å¤šä¸ªæ¶ˆè´¹è€…
        autoDelete: false,           // ä¸è‡ªåŠ¨åˆ é™¤ï¼šæ‰‹åŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
        arguments: null);

    // 3. é˜Ÿåˆ—ç»‘å®šï¼ˆåœ¨è®¢é˜…æ—¶åŠ¨æ€å»ºç«‹ï¼‰
    // è¿™ä¸ªç»‘å®šåœ¨ eventBus.Subscribe() æ—¶å»ºç«‹
    // channel.QueueBind(queue: _queueName, exchange: BROKER_NAME, routingKey: eventName);

    return channel;
}
```

4. å®Œæ•´çš„æ¶ˆæ¯æµè¯¦è§£

# æ­¥éª¤ 1ï¼šæœåŠ¡å¯åŠ¨æ—¶çš„åˆå§‹åŒ–

```
// æ¯ä¸ªå¾®æœåŠ¡å¯åŠ¨æ—¶ï¼š
public void Configure(IApplicationBuilder app)
{
    var eventBus = app.ApplicationServices.GetRequiredService<IEventBus>();

    // è®¢é˜…æ„Ÿå…´è¶£çš„äº‹ä»¶
    eventBus.Subscribe<OrderCreatedIntegrationEvent, OrderCreatedIntegrationEventHandler>();

    // å†…éƒ¨å‘ç”Ÿä»€ä¹ˆï¼š
    // 1. åœ¨ _handlers å­—å…¸ä¸­è®°å½•æ˜ å°„
    // 2. å»ºç«‹ RabbitMQ é˜Ÿåˆ—ç»‘å®š
}
```

RabbitMQ ä¸­çš„ç»“æœï¼š

```
Exchange: event_bus (Directç±»å‹)

é˜Ÿåˆ—å’Œç»‘å®šï¼š
- inventory_service é˜Ÿåˆ— â† ç»‘å®šåˆ° â†’ OrderCreatedIntegrationEvent (routingKey)
- notification_service é˜Ÿåˆ— â† ç»‘å®šåˆ° â†’ OrderCreatedIntegrationEvent (routingKey)
- payment_service é˜Ÿåˆ— â† ç»‘å®šåˆ° â†’ OrderCreatedIntegrationEvent (routingKey)
```

# æ­¥éª¤ 2ï¼šäº‹ä»¶å‘å¸ƒæ—¶çš„è·¯ç”±

```

// OrderService å‘å¸ƒäº‹ä»¶
_eventBus.Publish(new OrderCreatedIntegrationEvent(...));

// EventBus å†…éƒ¨ï¼š
public void Publish(IntegrationEvent @event)
{
    // routingKey = "OrderCreatedIntegrationEvent"
    channel.BasicPublish(
        exchange: "event_bus",
        routingKey: "OrderCreatedIntegrationEvent",  // å…³é”®ï¼
        body: serializedEvent);
}
```

RabbitMQ çš„è·¯ç”±é€»è¾‘ï¼š

```
å‘å¸ƒåˆ° Exchange: event_bus, routingKey: OrderCreatedIntegrationEvent

Exchange æŸ¥æ‰¾æ‰€æœ‰ç»‘å®šè¿™ä¸ª routingKey çš„é˜Ÿåˆ—ï¼š
- inventory_service âœ“ (ç»‘å®šäº† OrderCreatedIntegrationEvent)
- notification_service âœ“ (ç»‘å®šäº† OrderCreatedIntegrationEvent)
- payment_service âœ“ (ç»‘å®šäº† OrderCreatedIntegrationEvent)
- order_service âœ— (æ²¡æœ‰ç»‘å®š OrderCreatedIntegrationEvent)

ç»“æœï¼šæ¶ˆæ¯è¢«å¤åˆ¶3ä»½ï¼ŒæŠ•é€’åˆ°3ä¸ªé˜Ÿåˆ—
```

# æ­¥éª¤ 3ï¼šå„ä¸ªæœåŠ¡æ¶ˆè´¹æ¶ˆæ¯

```
// æ¯ä¸ªæœåŠ¡ç‹¬ç«‹æ¶ˆè´¹è‡ªå·±çš„é˜Ÿåˆ—
private void StartBasicConsume()
{
    var consumer = new AsyncEventingBasicConsumer(_consumerChannel);

    consumer.Received += async (model, ea) =>
    {
        // ea åŒ…å«ï¼šé˜Ÿåˆ—åç§°ã€æ¶ˆæ¯å†…å®¹ç­‰
        var message = Encoding.UTF8.GetString(ea.Body.Span);

        // å¤„ç†æ¶ˆæ¯ï¼ˆæ¯ä¸ªæœåŠ¡å¤„ç†è‡ªå·±çš„æ¶ˆæ¯å‰¯æœ¬ï¼‰
        await ProcessEvent(ea.RoutingKey, message);

        // ç¡®è®¤æ¶ˆæ¯ï¼ˆåªç¡®è®¤è‡ªå·±é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼‰
        _consumerChannel.BasicAck(ea.DeliveryTag, multiple: false);
    };

    // æ¯ä¸ªæœåŠ¡åªæ¶ˆè´¹è‡ªå·±çš„é˜Ÿåˆ—
    _consumerChannel.BasicConsume(
        queue: _queueName,  // å¦‚ "inventory_service"
        autoAck: false,
        consumer: consumer);
}
```

5. å®é™… RabbitMQ ç®¡ç†ç•Œé¢æŸ¥çœ‹
   å¯åŠ¨ RabbitMQ åï¼Œè®¿é—® http://localhost:15672 å¯ä»¥çœ‹åˆ°ï¼š
   Exchanges æ ‡ç­¾é¡µï¼š

```
Name: event_bus
Type: direct
Features: D
```

Queues æ ‡ç­¾é¡µï¼š

```
Name: inventory_service
State: running
Consumers: 1
Messages: 0  (å¦‚æœæœ‰æœªå¤„ç†çš„æ¶ˆæ¯ä¼šæ˜¾ç¤ºæ•°é‡)

Name: notification_service
State: running
Consumers: 1
Messages: 0

Name: order_service
State: running
Consumers: 1
Messages: 0
```

Bindings æ ‡ç­¾é¡µï¼š

```
Exchange: event_bus
Queue: inventory_service
Routing Key: OrderCreatedIntegrationEvent

Exchange: event_bus
Queue: notification_service
Routing Key: OrderCreatedIntegrationEvent

Exchange: event_bus
Queue: payment_service
Routing Key: OrderCreatedIntegrationEvent
```

6. è¿™ç§è®¾è®¡çš„å¥½å¤„
   è§£è€¦æ€§
   è§£è€¦æ€§
   csharp
   // æœåŠ¡ä¹‹é—´å®Œå…¨è§£è€¦

```
OrderService â†’ ä¸çŸ¥é“ â†’ InventoryService å­˜åœ¨
OrderService â†’ ä¸çŸ¥é“ â†’ NotificationService å­˜åœ¨
```

// åªéœ€è¦çŸ¥é“äº‹ä»¶å¥‘çº¦
å¼¹æ€§
csharp
// InventoryService å®•æœºæ—¶ï¼š

- OrderService: æ­£å¸¸å‘å¸ƒäº‹ä»¶ âœ…
- NotificationService: æ­£å¸¸æ¥æ”¶å¤„ç† âœ…
- InventoryService: æ¢å¤åå¤„ç†å †ç§¯çš„æ¶ˆæ¯ âœ…

// æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼ŒRabbitMQ ä¼šæŒä¹…åŒ–
å¯æ‰©å±•æ€§

```
// è½»æ¾æ·»åŠ æ–°æœåŠ¡
public class AnalyticsService
{
    public void Configure(IApplicationBuilder app)
    {
        var eventBus = app.ApplicationServices.GetRequiredService<IEventBus>();
        eventBus.Subscribe<OrderCreatedIntegrationEvent, AnalyticsEventHandler>();
        // æ–°å¢åˆ†ææœåŠ¡ï¼Œä¸å½±å“ç°æœ‰ç³»ç»Ÿ
    }
}

// RabbitMQ è‡ªåŠ¨å»ºç«‹æ–°ç»‘å®šï¼š
// analytics_service é˜Ÿåˆ— â† ç»‘å®šåˆ° â†’ OrderCreatedIntegrationEvent

```

# ç–‘é—®

# å¯¹ï¼Œæˆ‘å°±æ˜¯æƒ³çŸ¥é“ æ­¥éª¤ 2ï¼šäº‹ä»¶å‘å¸ƒæ—¶çš„è·¯ç”± è¿™é‡Œæåˆ°äº† routingKey: "OrderCreatedIntegrationEvent", // å…³é”®ï¼ï¼Œè¿™ä¸ªå¾ˆå…³é”®å“ˆï¼Œè¿™é‡Œå·²ç»ç¡®å®šäº†ï¼Œæ¶ˆæ¯è¿›å…¥åˆ°å“ªä¸ªé˜Ÿåˆ—ï¼Œå†³å®šäº†ï¼Œè®¢é˜…äººå¯ä»¥æ¶ˆè´¹è¿™ä¸ªæ¶ˆæ¯

routingKey: "OrderCreatedIntegrationEvent" ç¡®å®æ˜¯æ•´ä¸ªæ¶ˆæ¯è·¯ç”±çš„å…³é”®ï¼å®ƒå†³å®šäº†ï¼š

å“ªäº›é˜Ÿåˆ—èƒ½æ”¶åˆ°æ¶ˆæ¯

å“ªäº›è®¢é˜…è€…èƒ½æ¶ˆè´¹æ¶ˆæ¯

æ¶ˆæ¯å¦‚ä½•è¢«åˆ†å‘
![alt text](<../3. å‘å¸ƒæ¶ˆè´¹æ¶ˆæ¯.png>)

# queue: \_queueName, // æœåŠ¡è‡ªå·±çš„é˜Ÿåˆ—ï¼Œå¦‚ "inventory_service" é˜Ÿåˆ—çš„åå­—ç”Ÿå‘½ï¼Œå‘å¸ƒè€… publish çš„æ—¶å€™æ˜¯ä¸å…³å¿ƒçš„å—ï¼Œä»–éœ€è¦å¤åˆ¶æ¶ˆæ¯ä¸ºå‡ ä»½ åˆ†åˆ«å­˜æ”¾åˆ°ä¸åŒçš„é˜Ÿåˆ—é‡Œé¢å§ï¼Œåªæ˜¯æˆ‘ä»¬ code å±‚é¢çœ‹ä¸åˆ°è€Œå·²ï¼Œ

é‡æ–°ç»„ç»‡çš„æè¿°ï¼š

åœ¨ RabbitMQ çš„å®ç°ä¸­ï¼Œæ•´ä¸ªæ¶ˆæ¯è·¯ç”±æœºåˆ¶æ˜¯è¿™æ ·çš„ï¼š

1. é˜Ÿåˆ—åˆ›å»ºå’Œç»‘å®šï¼šå½“æˆ‘ä»¬åœ¨ä»£ç ä¸­è®¢é˜…äº‹ä»¶æ—¶ï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªé˜Ÿåˆ—åç§°ã€‚RabbitMQ ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åˆ›å»ºè¿™ä¸ªé˜Ÿåˆ—ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰ï¼Œå¹¶å°†è¯¥é˜Ÿåˆ—ç»‘å®šåˆ°æŒ‡å®šçš„ routingKeyï¼ˆå³äº‹ä»¶ç±»å‹åç§°ï¼‰ä¸Šã€‚

2. æ¶ˆæ¯è·¯ç”±ï¼šå½“å‘å¸ƒè€…å‘å¸ƒæ¶ˆæ¯æ—¶ï¼Œåªéœ€è¦æŒ‡å®š routingKeyï¼ŒRabbitMQ ä¼šè‡ªåŠ¨æŸ¥æ‰¾æ‰€æœ‰ç»‘å®šåˆ°è¿™ä¸ª routingKey çš„é˜Ÿåˆ—ï¼Œå¹¶å°†æ¶ˆæ¯åˆ†å‘åˆ°è¿™äº›é˜Ÿåˆ—ä¸­ã€‚

3. æ¶ˆæ¯æ¶ˆè´¹ï¼šæ¯ä¸ªæœåŠ¡ä»è‡ªå·±ä¸“å±çš„é˜Ÿåˆ—ä¸­æ¶ˆè´¹æ¶ˆæ¯ï¼Œå®ç°äº†è§£è€¦å’Œç‹¬ç«‹å¤„ç†

# é—®é¢˜å“ˆ channel.ExchangeDeclare(exchange: BROKER_NAME, type: "direct"); å°±æ˜¯è¿™ä¸ª ä¸­è½¬ç«™ BROKER_NAMEï¼Œæ˜¯å‘é€æ–¹å‘é€æ¶ˆæ¯ å’Œ è®¢é˜…æ–¹ æ¶ˆè´¹æ¶ˆæ¯æ—¶å€™ï¼Œä»–çš„ä½œç”¨

1. Exchange çš„æ ¸å¿ƒä½œç”¨ï¼šæ¶ˆæ¯è·¯ç”±ä¸­æ¢

```
const string BROKER_NAME = "event_bus";  // è¿™å°±æ˜¯æ¶ˆæ¯çš„ä¸­è½¬ç«™

// Exchange çš„ä½œç”¨ç±»ä¼¼äºé‚®å±€çš„åˆ†æ‹£ä¸­å¿ƒï¼š
// å‘é€æ–¹ â†’ åˆ†æ‹£ä¸­å¿ƒ â†’ æ ¹æ®åœ°å€åˆ†æ‹£ â†’ æŠ•é€’åˆ°æ­£ç¡®çš„é‚®ç®±
```

2. å‘é€æ–¹å¦‚ä½•ä½¿ç”¨ Exchange
   å‘é€è¿‡ç¨‹ï¼š

```
public void Publish(IntegrationEvent @event)
{
    using (var channel = _persistentConnection.CreateModel())
    {
        // 1. ç¡®ä¿"åˆ†æ‹£ä¸­å¿ƒ"å­˜åœ¨
        channel.ExchangeDeclare(exchange: BROKER_NAME, type: "direct");

        // 2. æŠŠæ¶ˆæ¯é€åˆ°"åˆ†æ‹£ä¸­å¿ƒ"ï¼Œå¹¶å‘Šè¯‰åœ°å€
        channel.BasicPublish(
            exchange: BROKER_NAME,           // ğŸ¯ é€åˆ°å“ªä¸ªåˆ†æ‹£ä¸­å¿ƒ
            routingKey: "OrderCreatedEvent", // ğŸ¯ æ¶ˆæ¯çš„"æ”¶ä»¶åœ°å€"
            body: message);                  // ğŸ¯ æ¶ˆæ¯å†…å®¹
    }
}
```

ç±»æ¯”ç†è§£ï¼š

Exchange (BROKER_NAME) = é‚®å±€åˆ†æ‹£ä¸­å¿ƒ

routingKey = æ”¶ä»¶äººåœ°å€

æ¶ˆæ¯ = ä¿¡ä»¶å†…å®¹

3. è®¢é˜…æ–¹å¦‚ä½•ä½¿ç”¨ Exchange
   è®¢é˜…è¿‡ç¨‹ï¼š

```
public void Subscribe<T, TH>()
{
    var eventName = "OrderCreatedEvent";  // è¦ç›‘å¬çš„æ¶ˆæ¯ç±»å‹

    // å‘Šè¯‰åˆ†æ‹£ä¸­å¿ƒï¼š"å‡¡æ˜¯å¯„å¾€è¿™ä¸ªåœ°å€çš„ä¿¡ï¼Œéƒ½æ”¾åˆ°æˆ‘çš„é‚®ç®±é‡Œ"
    _consumerChannel.QueueBind(
        queue: _queueName,           // ğŸ¯ æˆ‘çš„ä¸“å±é‚®ç®±
        exchange: BROKER_NAME,       // ğŸ¯ å“ªä¸ªåˆ†æ‹£ä¸­å¿ƒ
        routingKey: eventName);      // ğŸ¯ ç›‘å¬å“ªä¸ªåœ°å€çš„ä¿¡ä»¶
}
```

4. å®Œæ•´çš„æ•°æ®æµ

![alt text](<../4. å¯è§†åŒ–æµç¨‹.png>)
å…·ä½“ç¤ºä¾‹ï¼š

```
// åœºæ™¯ï¼šè®¢å•æœåŠ¡å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
_eventBus.Publish(new OrderCreatedIntegrationEvent(123));

// RabbitMQ å†…éƒ¨å‘ç”Ÿï¼š
// 1. æ¶ˆæ¯åˆ°è¾¾ event_bus Exchange
// 2. Exchange æŸ¥æ‰¾æ‰€æœ‰ç»‘å®šåˆ° "OrderCreatedIntegrationEvent" çš„é˜Ÿåˆ—
// 3. å‘ç°ï¼šinventory_service é˜Ÿåˆ—å’Œ notification_service é˜Ÿåˆ—
// 4. å°†æ¶ˆæ¯å¤åˆ¶ä¸¤ä»½ï¼Œåˆ†åˆ«æŠ•é€’åˆ°è¿™ä¸¤ä¸ªé˜Ÿåˆ—

// ç»“æœï¼š
// - InventoryService ä» inventory_service é˜Ÿåˆ—æ”¶åˆ°æ¶ˆæ¯
// - NotificationService ä» notification_service é˜Ÿåˆ—æ”¶åˆ°æ¶ˆæ¯
```
